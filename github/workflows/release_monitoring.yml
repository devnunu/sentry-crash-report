name: Release Monitoring

on:
  # ìˆ˜ë™ ì‹¤í–‰ (ìƒˆ ë¦´ë¦¬ì¦ˆ ëª¨ë‹ˆí„°ë§ ì‹œìž‘)
  workflow_dispatch:
    inputs:
      action:
        description: 'ì‹¤í–‰í•  ìž‘ì—…'
        required: true
        type: choice
        options:
          - 'start_monitoring'
          - 'cancel_monitoring'
          - 'status_check'
        default: 'start_monitoring'
      release_version:
        description: 'ë¦´ë¦¬ì¦ˆ ë²„ì „ (ì˜ˆ: 4.66.0)'
        required: false
        type: string
      release_start_time:
        description: 'ë¦´ë¦¬ì¦ˆ ì‹œìž‘ ì‹œê°„ (YYYY-MM-DD HH:MM KST, ë¹„ì›Œë‘ë©´ í˜„ìž¬ ì‹œê°„)'
        required: false
        type: string
        default: ''
      monitoring_duration:
        description: 'ëª¨ë‹ˆí„°ë§ ê¸°ê°„ (ì‹œê°„ ë‹¨ìœ„, ê¸°ë³¸ 7ì¼)'
        required: false
        type: string
        default: '168'

  # ìžë™ ì‹¤í–‰ (15ë¶„ë§ˆë‹¤ ì²´í¬)
  schedule:
    - cron: '*/15 * * * *'  # 15ë¶„ë§ˆë‹¤ ì‹¤í–‰

jobs:
  release-monitoring:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # íƒ€ìž„ì•„ì›ƒ ì„¤ì • (ë¬´í•œ ëŒ€ê¸° ë°©ì§€)

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # monitoring_state.json íŒŒì¼ ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•˜ê¸° ìœ„í•´ í† í° í•„ìš”
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'  # pip ìºì‹œ í™œìš©

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests python-dotenv

      - name: Validate required secrets
        run: |
          # í•„ìˆ˜ ì‹œí¬ë¦¿ ê²€ì¦
          if [ -z "${{ secrets.SENTRY_AUTH_TOKEN }}" ]; then
            echo "âŒ SENTRY_AUTH_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          if [ -z "${{ secrets.SENTRY_ORG_SLUG }}" ]; then
            echo "âŒ SENTRY_ORG_SLUGê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          if [ -z "${{ secrets.SENTRY_PROJECT_SLUG }}" ]; then
            echo "âŒ SENTRY_PROJECT_SLUGê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          echo "âœ… í•„ìˆ˜ ì‹œí¬ë¦¿ ê²€ì¦ ì™„ë£Œ"

      - name: Run Release Monitoring
        env:
          # Sentry ì„¤ì •
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG_SLUG: ${{ secrets.SENTRY_ORG_SLUG }}
          SENTRY_PROJECT_SLUG: ${{ secrets.SENTRY_PROJECT_SLUG }}
          SENTRY_PROJECT_ID: ${{ secrets.SENTRY_PROJECT_ID }}
          SENTRY_ENVIRONMENT: ${{ secrets.SENTRY_ENVIRONMENT }}

          # Slack ì„¤ì •
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

          # ëŒ€ì‹œë³´ë“œ ì„¤ì • (ì„ íƒì‚¬í•­)
          DASH_BOARD_ID: ${{ secrets.DASH_BOARD_ID }}

          # GitHub Actions ìž…ë ¥ê°’
          INPUT_ACTION: ${{ github.event.inputs.action }}
          INPUT_RELEASE_VERSION: ${{ github.event.inputs.release_version }}
          INPUT_RELEASE_START_TIME: ${{ github.event.inputs.release_start_time }}
          INPUT_MONITORING_DURATION: ${{ github.event.inputs.monitoring_duration }}

          # GitHub ê´€ë ¨ ì •ë³´
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_SERVER_URL: ${{ github.server_url }}

          # ì‹¤í–‰ ëª¨ë“œ êµ¬ë¶„
          TEST_MODE: false
        run: |
          echo "ðŸš€ ë¦´ë¦¬ì¦ˆ ëª¨ë‹ˆí„°ë§ ì‹œìž‘..."
          echo "ðŸ“… ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸ‘¤ ì‹¤í–‰ìž: ${{ github.actor }}"
          echo "ðŸŽ¯ ìž‘ì—…: ${{ github.event.inputs.action }}"
          
          # ìž‘ì—…ë³„ ì‹¤í–‰
          case "${{ github.event.inputs.action }}" in
            "start_monitoring")
              echo "ðŸ“ ëª¨ë‹ˆí„°ë§ ì‹œìž‘ ëª¨ë“œ"
              if [ -z "${{ github.event.inputs.release_version }}" ]; then
                echo "âŒ ë¦´ë¦¬ì¦ˆ ë²„ì „ì´ í•„ìš”í•©ë‹ˆë‹¤."
                exit 1
              fi
              ;;
            "cancel_monitoring")
              echo "ðŸ—‘ï¸ ëª¨ë‹ˆí„°ë§ ì·¨ì†Œ ëª¨ë“œ"
              if [ -z "${{ github.event.inputs.release_version }}" ]; then
                echo "âŒ ì·¨ì†Œí•  ë¦´ë¦¬ì¦ˆ ë²„ì „ì´ í•„ìš”í•©ë‹ˆë‹¤."
                exit 1
              fi
              ;;
            "status_check")
              echo "ðŸ“Š ìƒíƒœ í™•ì¸ ëª¨ë“œ"
              ;;
            *)
              echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ìž‘ì—…: ${{ github.event.inputs.action }}"
              exit 1
              ;;
          esac
          
          python release_monitoring/release_monitor.py

      - name: Handle monitoring failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # ì‹¤íŒ¨ ì‹œ Slack ì•Œë¦¼ ì „ì†¡
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "ðŸš¨ ë¦´ë¦¬ì¦ˆ ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ðŸš¨ ë¦´ë¦¬ì¦ˆ ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨*\n\nâ€¢ ì €ìž¥ì†Œ: `${{ github.repository }}`\nâ€¢ ì‹¤í–‰ìž: ${{ github.actor }}\nâ€¢ ì‹¤í–‰ ID: ${{ github.run_id }}\nâ€¢ ì‹œê°„: '"$(date)"'"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "GitHub Actions ë¡œê·¸ í™•ì¸"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ]
                  }
                ]
              }'
          fi

      - name: Commit monitoring state changes
        if: always()
        run: |
          # Git ì„¤ì •
          git config --local user.email "actions@github.com"
          git config --local user.name "Release Monitor Bot"
          
          # monitoring_state.json ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
          if [ -f "release_monitoring/monitoring_state.json" ]; then
            if ! git diff --exit-code release_monitoring/monitoring_state.json > /dev/null 2>&1; then
              echo "ðŸ“ ëª¨ë‹ˆí„°ë§ ìƒíƒœ ë³€ê²½ì‚¬í•­ ê°ì§€, ì»¤ë°‹ ì¤‘..."
              git add release_monitoring/monitoring_state.json
              
              # ì»¤ë°‹ ë©”ì‹œì§€ì— ë” ë§Žì€ ì •ë³´ í¬í•¨
              if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                COMMIT_MSG="ðŸš€ ë¦´ë¦¬ì¦ˆ ëª¨ë‹ˆí„°ë§ ìƒíƒœ ì—…ë°ì´íŠ¸: ${{ github.event.inputs.release_version }} [skip ci]"
              else
                COMMIT_MSG="â° ì •ê¸° ëª¨ë‹ˆí„°ë§ ìƒíƒœ ì—…ë°ì´íŠ¸ [skip ci]"
              fi
              
              git commit -m "$COMMIT_MSG"
              git push
              echo "âœ… ëª¨ë‹ˆí„°ë§ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "ðŸ“„ ëª¨ë‹ˆí„°ë§ ìƒíƒœ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            fi
          else
            echo "âš ï¸ monitoring_state.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: monitoring-failure-logs-${{ github.run_id }}
          path: |
            release_monitoring/monitoring_state.json
            release_monitoring/debug_output/
          retention-days: 7
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ ë¦´ë¦¬ì¦ˆ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ìœ í˜•**: ${{ github.event_name == 'workflow_dispatch' && 'ìˆ˜ë™ ì‹¤í–‰' || 'ìžë™ ì‹¤í–‰' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ìž**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "- **ë¦´ë¦¬ì¦ˆ ë²„ì „**: ${{ github.event.inputs.release_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ëª¨ë‹ˆí„°ë§ ê¸°ê°„**: ${{ github.event.inputs.monitoring_duration }}ì‹œê°„" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "- **ìƒíƒœ**: âœ… ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ìƒíƒœ**: âŒ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi